#!/usr/bin/env bash
set -euo pipefail
PROJECT_DIR="$(cd -- "$(dirname "${BASH_SOURCE}")" ; cd .. > /dev/null 2>&1 && pwd -P)"
cd $PROJECT_DIR

source bin/database.sh

psql -d template1 <<HERE
  SELECT pg_terminate_backend(pg_stat_activity.pid)
    FROM pg_stat_activity
    WHERE pg_stat_activity.datname = '${PGDATABASE}'
      AND pid <> pg_backend_pid();
HERE
$(dropdb "${PGDATABASE}" || exit 0) # prevent error when db not exists

./bin/db-migrate

#vi: ft=sh
